{"version":3,"file":"swipegraph.min.js","sources":["../src/RefObject.js","../src/utils.js","../src/getObjectURL.js","../src/setViewer.js","../src/polyfill-find.js","../src/polyfill-assign.js","../src/index.js"],"sourcesContent":["export default class {\n  constructor(elem) {\n    this.elem = elem;\n    this.readyState = 'waiting';\n    this.$eventList = {};\n  }\n\n  $setMounted(value) {\n    this.readyState = 'mounted';\n    this.dispatch('mounted', value);\n  }\n\n  addSrcIndex(value) {\n    this.dispatch('addSrcIndex', value);\n    return this;\n  }\n\n  setSrcIndex(value) {\n    this.dispatch('setSrcIndex', value);\n    return this;\n  }\n\n  detach() {\n    this.dispatch('$detach');\n  }\n\n  on(type, callback) {\n    this.$eventList[type] = this.$eventList[type] || [];\n    this.$eventList[type].push(callback);\n    return this;\n  }\n\n  off(type, callback) {\n    if (this.$eventList[type]) {\n      const index = this.$eventList[type].indexOf(callback);\n      if (index !== -1) this.$eventList[type].splice(index, 1);\n    }\n\n    return this;\n  }\n\n  one(type, callback) {\n    const fn = (e) => {\n      callback.call(this, e);\n      this.off(type, fn);\n    };\n    this.on(type, fn);\n    return this;\n  }\n\n  dispatch(type, value) {\n    if (this.$eventList[type]) {\n      this.$eventList[type].forEach((callback) => {\n        callback.call(this, { type, value, target: this });\n      });\n    }\n\n    return this;\n  }\n}\n","const initedClassName = 'swipegraph-isinit';\n\nfunction getVisiblePlayer(list) {\n  const result = [];\n\n  list.forEach((refObject) => {\n    const bounding = refObject.elem.getBoundingClientRect();\n    const wh = window.innerHeight;\n\n    if (bounding.top < wh && bounding.top > -bounding.height) result.push(refObject);\n  });\n\n  return result;\n}\n\nexport default {\n  initedClassName,\n  formatValue(elem, val) {\n    return Object.assign(\n      ['id', 'src', 'ref']\n        .reduce((prev, key) => (Object.assign({}, prev, { [key]: elem.getAttribute(`data-${key}`) })), {}),\n      ['length', 'autoswipe']\n        .reduce((prev, key) => (Object.assign({}, prev, { [key]: JSON.parse(elem.getAttribute(`data-${key}`)) })), {}),\n      val,\n    );\n  },\n  genInfo(param) {\n    const queryString = param.$auth ? `?${param.$auth}` : '';\n    return Object.assign(\n      {\n        queryString,\n        cdnQueryString: param.$cdnAuth ? `?${param.$cdnAuth}` : queryString,\n        autoswipe: true,\n      },\n      param,\n    );\n  },\n  initAutoSwipe(refList) {\n    let prevScrollY = 0;\n\n    window.addEventListener('scroll', () => {\n      const scrollY = window.scrollY;\n      if (Math.abs(scrollY - prevScrollY) < 20) return;\n\n      const value = scrollY - prevScrollY < 0 ? -1 : 1;\n\n      getVisiblePlayer(refList).forEach((refObject) => {\n        refObject.addSrcIndex(value);\n      });\n\n      prevScrollY = scrollY;\n    }, false);\n  },\n  addStyle(elem, style) {\n    Object.keys(style).forEach(function(name) {\n      elem.style[name] = style[name];\n    });\n  },\n};\n","const URL = window.URL || window.webkitURL;\n\nexport default (url, cb) => {\n  const xhr = new XMLHttpRequest();\n  xhr.open('GET', url);\n  xhr.responseType = 'blob';\n  xhr.onload = (e) => cb(URL.createObjectURL(e.target.response));\n  xhr.send();\n}\n","import utils from './utils';\nimport getObjectURL from './getObjectURL';\nconst { addStyle } = utils;\n\nexport default (root, info, refObject) => {\n  let initSwiped = false;\n  let swiping = false;\n  let prevX = null;\n  let prevY = null;\n  let nextDelta = 1;\n  let srcIndex = -1;\n  const urlCache = [];\n\n  const image = new Image();\n  root.appendChild(image);\n\n  image.onload = (e) => {\n    const target = e.target;\n    const height = target.naturalHeight;\n    const width = target.naturalWidth;\n    root.style.paddingTop = height / width * 100 + '%';\n    target.onload = null;\n\n    addStyle(image, {\n      width: '100%',\n      height: '100%',\n      position: 'absolute',\n      top: 0,\n      left: 0,\n      backfaceVisibility: 'hidden',\n    });\n\n    refObject.$setMounted({\n      width,\n      height,\n    })\n  };\n\n  const touchElem = document.createElement('div');\n  addStyle(touchElem, {\n    width: '100%',\n    height: '100%',\n    position: 'absolute',\n    zIndex: 1000000,\n    top: 0,\n    left: 0,\n  });\n  root.appendChild(touchElem);\n\n  const swipeStart = (e) => {\n    e.preventDefault();\n    initSwiped = true;\n    swiping = true;\n    touchElem.style.position = 'fixed';\n  };\n\n  const swipeEnd = () => {\n    swiping = false;\n    touchElem.style.position = 'absolute';\n  };\n\n  touchElem.addEventListener('mousedown', swipeStart, false);\n  touchElem.addEventListener('touchstart', swipeStart, false);\n\n  touchElem.addEventListener('mouseup', swipeEnd, false);\n  touchElem.addEventListener('touchend', swipeEnd, false);\n\n  const canceler = setInterval(() => {\n    if (nextDelta === 0) return;\n\n    let swipedIndex = (srcIndex + nextDelta) % info.length;\n    if (swipedIndex < 0) {\n      swipedIndex += info.length;\n    }\n    \n    const i = srcIndex = swipedIndex;\n    if (!urlCache[i]) {\n      getObjectURL(`${info.src}/${info.id}/${i + 1}.jpg${info.queryString}`, (url) => {\n        urlCache[i] = url;\n        image.src = url;\n      });\n    } else image.src = urlCache[i];\n\n    nextDelta = 0;\n  }, 33);\n\n  const handleSwipe = (e) => {\n    if (!swiping && initSwiped) return;\n\n    const x = typeof e.clientX === 'number' ? e.clientX : e.touches[0].pageX;\n    const y = typeof e.clientY === 'number' ? e.clientY : e.touches[0].pageY;\n    \n    if (prevX === null) {\n      prevX = x;\n      prevY = y;\n    } else if (Math.abs(x - prevX) > Math.abs(y - prevY)) {\n      nextDelta = x - prevX > 0 ? -1 : 1;\n      prevX = x;\n      prevY = y;\n    } else {\n      nextDelta = y - prevY > 0 ? -1 : 1;\n      prevX = x;\n      prevY = y;\n    }\n  };\n\n  refObject.on('addSrcIndex', e => nextDelta = e.value);\n  refObject.on('$detach', () => {\n    urlCache.forEach(url => URL.revokeObjectURL(url));\n    clearInterval(canceler);\n  });\n\n  touchElem.addEventListener('mousemove', handleSwipe, false);\n  touchElem.addEventListener('touchmove', handleSwipe, false);\n}","if (!Array.prototype.find) {\n  Array.prototype.find = function(predicate) {\n    if (this === null) {\n      throw new TypeError('Array.prototype.find called on null or undefined');\n    }\n    if (typeof predicate !== 'function') {\n      throw new TypeError('predicate must be a function');\n    }\n    var list = Object(this);\n    var length = list.length >>> 0;\n    var thisArg = arguments[1];\n    var value;\n\n    for (var i = 0; i < length; i++) {\n      value = list[i];\n      if (predicate.call(thisArg, value, i, list)) {\n        return value;\n      }\n    }\n    return undefined;\n  };\n}\n","if (typeof Object.assign != 'function') {\n  // Must be writable: true, enumerable: false, configurable: true\n  Object.defineProperty(Object, \"assign\", {\n    value: function assign(target, varArgs) { // .length of function is 2\n      'use strict';\n      if (target == null) { // TypeError if undefined or null\n        throw new TypeError('Cannot convert undefined or null to object');\n      }\n\n      var to = Object(target);\n\n      for (var index = 1; index < arguments.length; index++) {\n        var nextSource = arguments[index];\n\n        if (nextSource != null) { // Skip over if undefined or null\n          for (var nextKey in nextSource) {\n            // Avoid bugs when hasOwnProperty is shadowed\n            if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\n              to[nextKey] = nextSource[nextKey];\n            }\n          }\n        }\n      }\n      return to;\n    },\n    writable: true,\n    configurable: true\n  });\n}","import RefObject from './RefObject';\nimport utils from './utils';\nimport setViewer from './setViewer';\nimport './polyfill-find';\nimport './polyfill-assign';\n\nconst { initedClassName, formatValue, genInfo, addStyle } = utils;\n\nconst VERSION = process.env.VERSION;\nconst refObjectCache = [];\nutils.initAutoSwipe(refObjectCache);\n\nconst swipegraph = {\n  version: VERSION,\n  config: { autoEmbed: true },\n  refs: {},\n  attach: (elem, value) => {\n    if (new RegExp(initedClassName).test(elem.className)) {\n      return refObjectCache.find(ref => ref.elem === elem);\n    }\n\n    elem.classList.add(initedClassName);\n\n    const param = formatValue(elem, value);\n\n    const refObject = new RefObject(elem);\n    refObjectCache.push(refObject);\n\n    if (param.ref) swipegraph.refs[param.ref] = refObject;\n\n    const root = document.createElement('div');\n    addStyle(root, {\n      position: 'relative',\n    });\n    elem.appendChild(root);\n\n    const info = genInfo(param);\n    setViewer(root, info, refObject);\n\n    refObject.on('$detach', ({ target }) => {\n      target.elem.classList.remove(initedClassName);\n      const index = refObjectCache.indexOf(target);\n      if (index !== -1) refObjectCache.splice(index, 1);\n      Object.keys(swipegraph.refs).forEach((ref) => {\n        if (swipegraph.refs[ref] === target) {\n          swipegraph.refs[ref] = null;\n          delete swipegraph.refs[ref];\n        }\n      });\n\n      target.elem.removeChild(root);\n    });\n\n    return refObject;\n  },\n  detach: (elem) => {\n    const refObject = refObjectCache.find(t => t.elem === elem);\n    if (refObject) refObject.detach();\n  },\n};\n\nif (typeof window === 'object') {\n  const embed = () => {\n    Array.prototype.forEach.call(document.querySelectorAll('.swipegraph'), (elem) => { swipegraph.attach(elem); });\n  };\n\n  // setTimeout for rewriting config\n  setTimeout(() => {\n    if (swipegraph.config.autoEmbed) {\n      if (document.readyState !== 'loading') embed();\n      else window.addEventListener('DOMContentLoaded', embed, false);\n    }\n  });\n\n  /* eslint-disable no-console */\n  console.log(`SwipeGraph v${VERSION}`);\n};\n\nexport default swipegraph;\n"],"names":["elem","readyState","$eventList","value","dispatch","this","type","callback","push","index","indexOf","splice","on","fn","e","call","off","forEach","target","val","Object","assign","reduce","prev","key","getAttribute","JSON","parse","param","queryString","$auth","$cdnAuth","refList","prevScrollY","addEventListener","scrollY","window","Math","abs","list","result","refObject","bounding","getBoundingClientRect","wh","innerHeight","top","height","addSrcIndex","style","keys","name","URL","webkitURL","addStyle","utils","root","info","initSwiped","swiping","prevX","prevY","nextDelta","srcIndex","urlCache","image","Image","appendChild","onload","naturalHeight","width","naturalWidth","paddingTop","$setMounted","touchElem","document","createElement","swipeStart","preventDefault","position","swipeEnd","canceler","setInterval","swipedIndex","length","url","cb","xhr","i","src","id","XMLHttpRequest","open","responseType","createObjectURL","response","send","handleSwipe","x","clientX","touches","pageX","y","clientY","pageY","revokeObjectURL","Array","prototype","find","predicate","TypeError","thisArg","arguments","defineProperty","varArgs","to","nextSource","nextKey","hasOwnProperty","initedClassName","formatValue","genInfo","refObjectCache","swipegraph","autoEmbed","RegExp","test","className","ref","classList","add","RefObject","refs","remove","removeChild","t","detach","embed","querySelectorAll","attach","config","log"],"mappings":"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"}